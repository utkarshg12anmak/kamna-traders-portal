<!--
{% comment %}  
  Usage:
    {% include "components/data-table.html" 
        with
          columns=columns_list
          rows=rows_list
          freeze_left=2
          freeze_right=1
    %}
{% endcomment %} -->

{% load custom_filters %}



<style>
  .data-table-container {
    position: relative;
    overflow: auto;
    width: 100%;
  }
  table.data-table {
    border-collapse: collapse;
    width: max-content;   /* allow horizontal scroll */
  }
  .data-table th, .data-table td {
    padding: .5rem 1rem;
    border: 1px solid #ddd;
    background: #fff;
    white-space: nowrap;
  }
  .data-table .sticky {
    position: sticky;
    background: #F9F9F9;
    z-index: 2;
  }
  .data-table .sticky-header {
    z-index: 3;
  }
</style>

<div class="data-table-container"
     data-freeze-left="{{ freeze_left }}"
     data-freeze-right="{{ freeze_right }}">
  <table class="data-table">
    <thead>
      <tr>
        {% for col in columns %}
          <th class="{% if forloop.parentloop %}{% endif %}">{{ col.title }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for row in rows %}
        <tr>
          {% for col in columns %}
            <td>{{ row|default_if_none:''|dict_get:col.key }}</td>
          {% endfor %}
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
  // Call once per page load
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.data-table-container').forEach(container => {
      const freezeLeft  = parseInt(container.dataset.freezeLeft)  || 0;
      const freezeRight = parseInt(container.dataset.freezeRight) || 0;
      const table       = container.querySelector('table.data-table');
      const headers     = table.querySelectorAll('th');
      const rows        = table.querySelectorAll('tbody tr');

      // Freeze header row
      headers.forEach(th => {
        th.classList.add('sticky', 'sticky-header');
        th.style.top = '0';
      });

      // Helper to freeze a given column index at an offset
      function freezeColumn(idx, offset, side) {
        // header cell
        const h = headers[idx];
        h.classList.add('sticky');
        h.style[side] = offset + 'px';
        // body cells
        rows.forEach(row => {
          const cell = row.children[idx];
          cell.classList.add('sticky');
          cell.style[side] = offset + 'px';
        });
      }

      // Compute & apply for left side
      let leftOffset = 0;
      for (let i = 0; i < freezeLeft; i++) {
        const w = headers[i].offsetWidth;
        freezeColumn(i, leftOffset, 'left');
        leftOffset += w;
      }

      // Compute & apply for right side
      let rightOffset = 0;
      const colCount = headers.length;
      for (let j = 0; j < freezeRight; j++) {
        const idx = colCount - 1 - j;
        const w   = headers[idx].offsetWidth;
        freezeColumn(idx, rightOffset, 'right');
        rightOffset += w;
      }
    });
  });
</script>
