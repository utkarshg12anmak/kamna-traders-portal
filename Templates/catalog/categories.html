{# templates/Catalog/categories.html #}
{% extends "base.html" %}
{% load static %}
{% load custom_filters %}

{% block title %}Catalog Home{% endblock %}

{% block extra_head %}
{# page-specific favicons, scripts, etc. #}
<link
rel="icon"
href="{% static 'favicon_dark.svg' %}"
type="image/svg+xml"
media="(prefers-color-scheme: light)"
/>
<link
rel="icon"
href="{% static 'favicon_light.svg' %}"
type="image/svg+xml"
media="(prefers-color-scheme: dark)"
/>
{% endblock %}

{% block content %}
<section class="main-content">
    
    <!-- 2a) PAGE HEADER: Title + Record count + Buttons -->
    <div class="page-header">
        <h1 class="page-title">
            Manage Item Categories
            <small class="page-subtitle"> &nbsp; ({{ object_list|length }} Records)</small>
        </h1>
        <div class="action-buttons">
            {% include "components/button-plus.html" with text="Categories" type="button" data_open="categoryModal" class="ml-2" color="#358f80" dark_color="#036666"%}            
        </div>
    </div>
    
    <!-- 2b) FILTERS -->
    <div class="filters">

        {% include "components/button-filter.html" with text="Filter" id="applyCategoryFilters" %}   
        
        {% include "components/button-filter-reset.html" with text="Reset" id="clearCategoryFilters" %}    
    </div>
    
    <!-- 2c) TABLES -->
    <div class="tables">
            <div class="card">
      <div class="table-responsive">
        <table class="table" data-sticky-left="2" data-sticky-right="1">
          <thead>
            <tr>
              <th style="width:3rem; text-align:center;">#</th>
              <th>Name</th>
              <th>Parent</th>              
              <th>Created At</th>
              <th>Created By</th>
              <th>Updated At</th>
              <th>Updated By</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for cat in categories %}
            <tr>
              <td style="text-align:center;">{{ forloop.counter }}</td>              
              <td>{% include "components/status_pill.html" with label=cat.name %}</td>  
              <td>{% include "components/status_pill.html" with label=cat.parent.name %}</td>                           
              <td>{{ cat.created_at|date:"d-M-Y h:i A" }}</td>
              <td>{% include "components/profile_pill.html" with name=cat.created_by.get_full_name %}</td>
              <td>{{ cat.updated_at|date:"d-M-Y h:i A" }}</td>
              <td>{% include "components/profile_pill.html" with name=cat.updated_by.get_full_name %}</td>
              <td class="td-flex-center">
                {% include "components/button-edit.html" with data_open="editCatModal-{{ cat.id }}" %}
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="9" class="text-center text-muted">No categories found.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
            
            {% for cat in categories %}
            {% include "components/modal-form.html" with modal_id="editCatModal-{{ cat.id }}" form=category_forms|get_item:cat.id form_id="editCatForm-{{ cat.id }}" title="Edit Categories" action_url=request.path submit_text="Update" %}
            {% endfor %}

    </div>
    
</section>

{% include "components/modal-form.html" with modal_id="categoryModal" form_id="categoryForm" title="New Category" action_url=request.path form=form %}

{% include "components/pills.html" %}

<script>
document.addEventListener('DOMContentLoaded', () => {
  const btn      = document.getElementById('parentFilterBtn');
  const menu     = document.getElementById('parentFilterDropdown');
  const selectEl = document.getElementById('parentFilterSelect');
  const applyBtn = document.getElementById('applyCategoryFilters');
  const resetBtn = document.getElementById('clearCategoryFilters');

  // toggle
  btn.addEventListener('click', () => menu.classList.toggle('active'));
  document.addEventListener('click', e => {
    if (!btn.contains(e.target) && !menu.contains(e.target)) {
      menu.classList.remove('active');
    }
  });

  const choices = new Choices(selectEl, {
    removeItemButton: true,
    searchEnabled:    true,
    placeholderValue: 'Search parentsâ€¦',
    shouldSort:       false
  });

  applyBtn.addEventListener('click', () => {
    const vals = choices.getValue(true);
    const params = new URLSearchParams(window.location.search);
    params.delete('parents');
    vals.forEach(v => params.append('parents', v));
    window.location.search = params.toString();
  });

  resetBtn.addEventListener('click', () => {
    choices.clearStore();
    const params = new URLSearchParams(window.location.search);
    params.delete('parents');
    window.location.search = params.toString();
  });
});
</script>

{% endblock %}
