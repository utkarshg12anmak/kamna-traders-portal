{# templates/Catalog/items.html #}
{% extends "base.html" %}
{% load static %}

{% block title %}Catalog Items{% endblock %}

{% block extra_head %}
{# page-specific favicons, scripts, etc. #}
<link
rel="icon"
href="{% static 'favicon_dark.svg' %}"
type="image/svg+xml"
media="(prefers-color-scheme: light)"
/>
<link
rel="icon"
href="{% static 'favicon_light.svg' %}"
type="image/svg+xml"
media="(prefers-color-scheme: dark)"
/>
{% endblock %}

{% block content %}

<style>
/* static/css/catalog_modal.css */

/* Overlay backdrop for modals */
.modal-overlay {
  display: none;          /* Hidden by default */
  position: fixed;
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
  background-color: rgba(0, 0, 0, 0.4);
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

/* Modal container */
.modal {
  background-color: #ffffff;
  border-radius: 8px;
  width: 500px;
  max-height: 80vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

/* Header */
.modal-header {
  background-color: #ffffff;
  color: #ffffff;
  padding: 0.75rem 1rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.modal-header h2 {
  margin: 0;
  font-size: 1.25rem;
}
.modal-header button {
  background: transparent;
  border: none;
  color: #ffffff;
  font-size: 1.25rem;
  cursor: pointer;
}

/* Body */
.modal-body {
  padding: 1rem;
  overflow-y: auto;
  flex: 1;
}
.modal-body table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 1rem;
}
.modal-body th,
.modal-body td {
  border: 1px solid #ddd;
  padding: 0.5rem;
  text-align: left;
}
.modal-body input {
  width: 100%;
  box-sizing: border-box;
  padding: 0.25rem;
}

/* Footer */
.modal-footer {
  padding: 0.75rem 1rem;
  text-align: right;
  border-top: 1px solid #eee;
  background-color: #f9f9f9;
}
.modal-footer .btn-small {
  font-size: 0.875rem;
  padding: 0.25rem 0.5rem;
  margin-left: 0.5rem;
}

</style>



<section class="main-content">
    
    <!-- 2a) PAGE HEADER: Title + Record count + Buttons -->
    <div class="page-header">
        <h1 class="page-title">
            Manage Items
            <small class="page-subtitle"> &nbsp; ({{ object_list|length }} Records)</small>
        </h1>
        <div class="action-buttons">                    


{% include "components/button-plus.html" with text="Item" type="button"  class="ml-2" color="#3aa856" dark_color="#34974d"%}

{% include "components/button-plus.html" with text="Brand" type="button" onclick="openModal('brandModal')" class="ml-2" color="#0077b6" dark_color="#023e8a"%}         

{% include "components/button-plus.html" with text="Categories" type="button" class="ml-2" color="#d8572a" dark_color="#c32f27"%}         

{% include "components/button-plus.html" with text="Tax Rates" type="button"  onclick="openTaxModal()" class="ml-2" color="#8d99ae" dark_color="#2b2d42"%}         

{% include "components/button-plus.html" with text="UOM" type="button" onclick="openUomModal()" class="ml-2" color="#ff4d6d" dark_color="#c9184a"%}         


</div>
</div>

<!-- 2b) FILTERS -->
<div class="filters">
    <p>Filters go here</p>
</div>

<!-- 2c) TABLES -->
<div class="tables">
    <p>Tables go here</p>
</div>

</section>

{% include "catalog/uom_manage_popup.html" %}

<script>
// --- UOM Modal AJAX Logic ---
function openUomModal() {
  const overlay = document.getElementById('uomModal');
  // Show loading indicator
  overlay.style.display = 'flex';
  overlay.querySelector('.modal-body').innerHTML = '<div style="padding:2rem;text-align:center;">Loading...</div>';
  // Fetch latest modal content via AJAX
  fetch('{% url 'catalog:manage_uoms' %}')
    .then(response => response.text())
    .then(html => {
      // Extract only the form part from the returned HTML
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const form = doc.querySelector('#uom-formset');
      overlay.querySelector('.modal-body').innerHTML = '';
      if (form) {
        overlay.querySelector('.modal-body').appendChild(form);
        // Add a hidden template row for new UOMs
        const tbody = form.querySelector('#uom-table-body');
        if (tbody) {
          const templateRow = tbody.querySelector('tr:last-child').cloneNode(true);
          templateRow.style.display = 'none';
          templateRow.classList.add('uom-template-row');
          tbody.appendChild(templateRow);
        }
        attachUomModalHandlers();
      } else {
        overlay.querySelector('.modal-body').innerHTML = '<div style="color:red;">Failed to load form.</div>';
      }
    })
    .catch(() => {
      overlay.querySelector('.modal-body').innerHTML = '<div style="color:red;">Error loading form.</div>';
    });
  // Add click-outside-to-close
  overlay.onclick = function(e) {
    if (e.target === overlay) closeUomModal();
  };
}
function closeUomModal() {
  const overlay = document.getElementById('uomModal');
  overlay.style.display = 'none';
  overlay.onclick = null; // Remove handler to avoid leaks
}

// Attach handlers for add row and AJAX submit
function attachUomModalHandlers() {
  const form = document.getElementById('uom-formset');
  if (!form) return;
  // Add UOM row
  const addBtn = document.getElementById('add-uom-row');
  if (addBtn) {
    addBtn.onclick = function() {
      const tbody = document.getElementById('uom-table-body');
      const totalForms = form.querySelector('input[name$="-TOTAL_FORMS"]');
      const formIdx = parseInt(totalForms.value);
      // Use the hidden template row
      const templateRow = tbody.querySelector('.uom-template-row');
      if (!templateRow) return;
      const newRow = templateRow.cloneNode(true);
      newRow.style.display = '';
      newRow.classList.remove('uom-template-row');
      // Update all input names/ids in the new row
      newRow.querySelectorAll('input').forEach(input => {
        // Remove error classes
        input.classList.remove('error');
        if (input.type === 'checkbox') {
          input.checked = false;
        } else {
          input.value = '';
        }
        // Update name/index
        input.name = input.name.replace(/-(\d+)-/, `-${formIdx}-`);
        input.id = input.id.replace(/-(\d+)-/, `-${formIdx}-`);
      });
      // Remove error divs
      newRow.querySelectorAll('.field-error').forEach(e => e.remove());
      tbody.insertBefore(newRow, templateRow); // Always before the template
      totalForms.value = formIdx + 1;
    };
  }
  // AJAX form submit
  form.onsubmit = function(e) {
    e.preventDefault();
    const formData = new FormData(form);
    fetch(form.action, {
      method: 'POST',
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      body: formData
    })
    .then(resp => {
      // Try to parse as JSON, fallback to HTML
      return resp.json().catch(() => resp.text());
    })
    .then(data => {
      if (typeof data === 'object' && data.status === 'ok') {
        closeUomModal();
        // Optionally show a toast or reload UOMs elsewhere
      } else {
        // If errors, replace modal body with returned HTML (form with errors)
        const overlay = document.getElementById('uomModal');
        if (typeof data === 'string') {
          const parser = new DOMParser();
          const doc = parser.parseFromString(data, 'text/html');
          const form = doc.querySelector('#uom-formset');
          if (form) {
            overlay.querySelector('.modal-body').innerHTML = '';
            overlay.querySelector('.modal-body').appendChild(form);
            attachUomModalHandlers();
          } else {
            overlay.querySelector('.modal-body').innerHTML = '<div style="color:red;">Error saving UOMs.</div>';
          }
        }
      }
    })
    .catch(() => {
      const msg = document.getElementById('uom-ajax-message');
      if (msg) msg.innerHTML = '<span style="color:red;">Error saving UOMs.</span>';
    });
  };
}
</script>


{% endblock %}
